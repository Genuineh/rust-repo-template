name: Release

on:
  push:
    tags: ["v*"]

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Rust
        uses: dtolnay/rust-toolchain@v1
      - name: Parse project.toml
        id: parse
        run: |
          cargo run --quiet --bin cosmos -- project gha-outputs
      - name: Install toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          profile: minimal
      - name: Build (release)
        run: cargo build --all --release
      - name: Run tests
        run: cargo test --all --tests --verbose
      - name: Publish crates.io (if configured)
        if: ${{ contains(steps.parse.outputs.outputs_list, 'crate') && secrets.CARGO_REGISTRY_TOKEN }}
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: cargo publish --token $CARGO_REGISTRY_TOKEN || true
      - name: Docker build & push (if configured)
        if: ${{ steps.parse.outputs.outputs_contains_docker == 'true' }}
        run: |
          echo "Logging into ghcr.io"
          echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          docker build -t ${{ steps.parse.outputs.docker_image }}:${{ steps.parse.outputs.project_version }} -t ${{ steps.parse.outputs.docker_image }}:latest .
          docker push ${{ steps.parse.outputs.docker_image }}:${{ steps.parse.outputs.project_version }} || true
          docker push ${{ steps.parse.outputs.docker_image }}:latest || true

      - name: Prepare artifacts
        run: |
          mkdir -p release
          cp target/release/cosmos release/ || true
          tar -czf release/cosmos-${{ github.ref_name }}-linux.tar.gz -C release cosmos || true

      - name: Create GitHub Release
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          files: release/*
          body: |
            Automated release for ${{ github.ref_name }}
            
            Commit details:
            ${{ github.sha }}
